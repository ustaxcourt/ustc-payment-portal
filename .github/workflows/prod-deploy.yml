name: Production Deploy

on:
  release:
  types:
    - published


permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  DEV_ARTIFACT_BUCKET: ${{ vars.DEV_ARTIFACT_BUCKET || 'ustc-payment-portal-build-artifacts' }}

  jobs:
    promote:
      runs-on: ubuntu-latest
      timeout-minutes: 30
      outputs:
        sha: ${{ steps.resolve.outputs.sha }}
      steps:
        - name: Checkout
        uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Configure AWS Credentials (read dev artifacts)
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets.DEV_AWS_DEPLOYER_ROLE_ARN }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Select RC Candidate to deploy
          id: select
          run: |
            set -euo pipefail
            tag=$(git tag -l "*rc*" --sort=-version:refname | head -n 1)
            hash=$(git rev-list -n 1 $tag)
            echo "tag=$tag" >> $GITHUB_OUTPUT
            echo "sha=$hash" >> $GITHUB_OUTPUT

        - name: Validate artifacts exist for SHA
          run: |
            set -euo pipefail
            SHA='${{ steps.select.outputs.sha}}'
            echo "Validating artifacts for $SHA in s3://${DEV_ARTIFACT_BUCKET}/artifacts/stg/$SHA/"
            for f in initPayment processPayment getDetails testCert; do
              KEY="artifacts/stg/${SHA}/${f}.zip"
              aws s3api head-object --bucket "${DEV_ARTIFACT_BUCKET}" --key "$KEY" >/stg/null 2>&1 || {
                echo "Missing $KEY" >&2; exit 1; }
            done
            echo "All artifacts present"

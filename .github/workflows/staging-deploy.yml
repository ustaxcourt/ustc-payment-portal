name: CICD - Staging (Work in progress)

on:
  push:
    tags:
      - "v*.*.*-rc.*"
  workflow_dispatch:
    inputs:
      source_dev_tag:
        description: "Dev tag to promote (e.g., v1.2.3-dev.45). Leave empty to auto-select latest valid dev tag."
        required: false
        type: string

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  DEV_ARTIFACT_BUCKET: ${{ vars.DEV_ARTIFACT_BUCKET || 'ustc-payment-portal-build-artifacts' }}

jobs:
  promote:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      release_tag: ${{ steps.tag.outputs.version }}
      sha: ${{ steps.resolve.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials (read dev artifacts)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEV_AWS_DEPLOYER_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Select dev tag to promote
        id: select
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.source_dev_tag }}" ]; then
            echo "dev_tag=${{ inputs.source_dev_tag }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          git fetch --tags --force
          CANDIDATE=""
          while read -r tag; do
            [ -z "$tag" ] && continue
            sha=$(git rev-list -n 1 "$tag" 2>/dev/null || true)
            [ -z "$sha" ] && continue
            if aws s3 ls "s3://${DEV_ARTIFACT_BUCKET}/artifacts/dev/$sha/" >/dev/null 2>&1; then
              CANDIDATE="$tag"; break
            fi
          done < <(git tag -l "v*-dev.*" --sort=-version:refname)
          [ -z "$CANDIDATE" ] && { echo "No valid dev tag with artifacts found" >&2; exit 1; }
          echo "dev_tag=$CANDIDATE" >> $GITHUB_OUTPUT

      - name: Resolve SHA from dev tag
        id: resolve
        run: |
          set -euo pipefail
          TAG='${{ steps.select.outputs.dev_tag }}'
          SHA=$(git rev-list -n 1 "$TAG")
          [ -z "$SHA" ] && { echo "Unable to resolve commit for tag $TAG" >&2; exit 1; }
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Resolved: $TAG -> $SHA"

      - name: Validate artifacts exist for SHA
        run: |
          set -euo pipefail
          SHA='${{ steps.resolve.outputs.sha }}'
          echo "Validating artifacts for $SHA in s3://${DEV_ARTIFACT_BUCKET}/artifacts/dev/$SHA/"
          for f in initPayment processPayment getDetails testCert; do
            KEY="artifacts/dev/${SHA}/${f}.zip"
            aws s3api head-object --bucket "${DEV_ARTIFACT_BUCKET}" --key "$KEY" >/dev/null 2>&1 || {
              echo "Missing $KEY" >&2; exit 1; }
          done
          echo "All artifacts present"

      - name: Generate RC version tag
        id: tag
        env:
          TZ: UTC
        run: |
          set -euo pipefail
          chmod +x terraform/scripts/generate_version_tag.sh
          terraform/scripts/generate_version_tag.sh staging

      - name: Create and push RC tag at resolved SHA
        env:
          VERSION: ${{ steps.tag.outputs.version }}
        run: |
          set -euo pipefail
          [ -z "${VERSION:-}" ] && { echo "Empty VERSION" >&2; exit 1; }
          git fetch --tags --force
          if git rev-parse -q --verify "refs/tags/${VERSION}" >/dev/null; then
            echo "Tag ${VERSION} already exists; skipping"; exit 0; fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          SHA='${{ steps.resolve.outputs.sha }}'
          git tag -a "$VERSION" "$SHA" -m "Release candidate $VERSION for staging\nCommit: $SHA\nArtifacts: s3://${DEV_ARTIFACT_BUCKET}/artifacts/dev/$SHA/"
          git push origin "$VERSION"

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Resolve tag commit SHA
        id: rev
        run: |
          set -euo pipefail
          TAG='${{ github.ref_name }}'
          SHA=$(git rev-list -n 1 "$TAG")
          [ -z "$SHA" ] && { echo "Unable to resolve commit for tag $TAG" >&2; exit 1; }
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Resolved: $TAG -> $SHA"

      - name: Export artifact bucket (env)
        run: |
          echo "Dev bucket: $DEV_ARTIFACT_BUCKET"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"

      - name: Configure AWS Credentials (OIDC - Stg)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.STAGING_AWS_DEPLOYER_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS caller identity (to be removed later)
        run: aws sts get-caller-identity

      - name: Build artifact key map (dev bucket)
        id: artifacts
        run: |
          set -euo pipefail
          SHA='${{ steps.rev.outputs.sha }}'
          PREFIX="artifacts/dev/${SHA}"
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "initPayment=${PREFIX}/initPayment.zip" >> $GITHUB_OUTPUT
          echo "processPayment=${PREFIX}/processPayment.zip" >> $GITHUB_OUTPUT
          echo "getDetails=${PREFIX}/getDetails.zip" >> $GITHUB_OUTPUT
          echo "testCert=${PREFIX}/testCert.zip" >> $GITHUB_OUTPUT

      # - name: Fetch artifact hashes (to see if tf change is needed)
      #   id: hashes
      #   run: |
      #     set -euo pipefail
      #     get_hash() {
      #       KEY="$1"
      #       aws s3api head-object --bucket "${DEV_ARTIFACT_BUCKET}" --key "${KEY}" \
      #         | jq -r '.Metadata.sha256_b64 // empty'
      #     }
      #     echo "initPayment=$(get_hash '${{ steps.artifacts.outputs.initPayment }}')" >> $GITHUB_OUTPUT
      #     echo "processPayment=$(get_hash '${{ steps.artifacts.outputs.processPayment }}')" >> $GITHUB_OUTPUT
      #     echo "getDetails=$(get_hash '${{ steps.artifacts.outputs.getDetails }}')" >> $GITHUB_OUTPUT
      #     echo "testCert=$(get_hash '${{ steps.artifacts.outputs.testCert }}')" >> $GITHUB_OUTPUT

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
          terraform_version: ${{ vars.TERRAFORM_VERSION || '1.7.5' }}

      - name: Terraform Init (staging)
        working-directory: terraform/environments/stg
        run: |
          terraform init -input=false -backend-config=backend.hcl -reconfigure

      - name: Terraform Plan (staging)
        id: plan
        working-directory: terraform/environments/stg
        env:
          TF_VAR_artifact_bucket: ${{ env.DEV_ARTIFACT_BUCKET }}
          TF_VAR_initPayment_s3_key: ${{ steps.artifacts.outputs.initPayment }}
          TF_VAR_processPayment_s3_key: ${{ steps.artifacts.outputs.processPayment }}
          TF_VAR_getDetails_s3_key: ${{ steps.artifacts.outputs.getDetails }}
          TF_VAR_testCert_s3_key: ${{ steps.artifacts.outputs.testCert }}
          TF_VAR_initPayment_source_code_hash: ${{ steps.hashes.outputs.initPayment }}
          TF_VAR_processPayment_source_code_hash: ${{ steps.hashes.outputs.processPayment }}
          TF_VAR_getDetails_source_code_hash: ${{ steps.hashes.outputs.getDetails }}
          TF_VAR_testCert_source_code_hash: ${{ steps.hashes.outputs.testCert }}
        run: |
          set -euo pipefail
          terraform plan -input=false -out=tfplan
          terraform show -no-color tfplan > tfplan.txt || true

      - name: Terraform Apply (if required)
        if: ${{ steps.plan.outputs.exitcode == '2' }}
        working-directory: terraform/environments/stg
        env:
          TF_VAR_namespace: pr-${{ github.event.pull_request.number }}
          TF_VAR_artifact_bucket: ${{ steps.upload_artifacts_pr.outputs.artifact_bucket }}
          TF_VAR_initPayment_s3_key: ${{ steps.upload_artifacts_pr.outputs.initPayment_s3_key }}
          TF_VAR_processPayment_s3_key: ${{ steps.upload_artifacts_pr.outputs.processPayment_s3_key }}
          TF_VAR_getDetails_s3_key: ${{ steps.upload_artifacts_pr.outputs.getDetails_s3_key }}
          TF_VAR_testCert_s3_key: ${{ steps.upload_artifacts_pr.outputs.testCert_s3_key }}
          TF_VAR_initPayment_source_code_hash: ${{ steps.upload_artifacts_pr.outputs.initPayment_source_code_hash }}
          TF_VAR_processPayment_source_code_hash: ${{ steps.upload_artifacts_pr.outputs.processPayment_source_code_hash }}
          TF_VAR_getDetails_source_code_hash: ${{ steps.upload_artifacts_pr.outputs.getDetails_source_code_hash }}
          TF_VAR_testCert_source_code_hash: ${{ steps.upload_artifacts_pr.outputs.testCert_source_code_hash }}
        run: terraform apply -auto-approve tfplan

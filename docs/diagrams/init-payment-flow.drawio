<mxfile host="65bd71144e">
    <diagram name="Init Payment Flow" id="init-payment-flow">
        <mxGraphModel dx="2538" dy="1598" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1100" pageHeight="850" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="title" value="POST /init - Payment Initiation Flow" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1" parent="1" vertex="1">
                    <mxGeometry x="350" y="20" width="400" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="header-client" value="Client App&#xa;(DAWSON)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;fontStyle=1" parent="1" vertex="1">
                    <mxGeometry x="40" y="80" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="header-gateway" value="API Gateway" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;fontStyle=1" parent="1" vertex="1">
                    <mxGeometry x="200" y="80" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="header-lambda" value="Lambda&#xa;(Payment Portal)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1" parent="1" vertex="1">
                    <mxGeometry x="360" y="80" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="header-datastore" value="Datastore&#xa;(TBD)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=12;fontStyle=1;dashed=1" parent="1" vertex="1">
                    <mxGeometry x="520" y="80" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="header-logs" value="CloudWatch&#xa;Logs" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;fontStyle=1" parent="1" vertex="1">
                    <mxGeometry x="680" y="80" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="header-paygov" value="Pay.gov&#xa;SOAP API" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;fontStyle=1" parent="1" vertex="1">
                    <mxGeometry x="840" y="80" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="line-client" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="100" y="130" as="sourcePoint"/>
                        <mxPoint x="100" y="700" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="line-gateway" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="260" y="130" as="sourcePoint"/>
                        <mxPoint x="260" y="700" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="line-lambda" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="420" y="130" as="sourcePoint"/>
                        <mxPoint x="420" y="700" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="line-datastore" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="580" y="130" as="sourcePoint"/>
                        <mxPoint x="580" y="700" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="line-logs" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="740" y="130" as="sourcePoint"/>
                        <mxPoint x="740" y="700" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="line-paygov" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="900" y="130" as="sourcePoint"/>
                        <mxPoint x="900" y="700" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step1" value="1. POST /init&lt;br&gt;{transactionReferenceId, feeId, amount?,&lt;br&gt;appId, urlSuccess,&lt;br&gt;urlCancel}" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="100" y="160" as="sourcePoint"/>
                        <mxPoint x="260" y="160" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step2-box" value="2. Validate IAM&#xa;(SigV4 signature)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11" parent="1" vertex="1">
                    <mxGeometry x="200" y="190" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step3" value="3. Forward with&#xa;IAM identity" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="260" y="260" as="sourcePoint"/>
                        <mxPoint x="420" y="260" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step4-box" value="4. Validate request&#xa;(Joi schema)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11" parent="1" vertex="1">
                    <mxGeometry x="360" y="280" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step5" value="5. Log request" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=1;dashed=1;strokeColor=#9673a6;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="420" y="305" as="sourcePoint"/>
                        <mxPoint x="740" y="305" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step5a-auth" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#666666;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="420" y="335" as="sourcePoint"/>
                        <mxPoint x="580" y="335" as="targetPoint"/>
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step5a-label" value="5a. Authorize App for fee&lt;br&gt;(query client permissions, validate feeId in AllowedFees)&lt;br&gt;See: authentication-authorization-flow.drawio" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontStyle=0;labelBackgroundColor=#ffffff;" parent="step5a-auth" vertex="1" connectable="0">
                    <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
                        <mxPoint x="50" y="-5" as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step6" value="6. Save initial record&lt;br&gt;(status: Received)&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;strokeColor=#666666;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="420" y="375" as="sourcePoint"/>
                        <mxPoint x="580" y="375" as="targetPoint"/>
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step7" value="7. StartOnlineCollection&#xa;(SOAP + mTLS cert)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="420" y="425" as="sourcePoint"/>
                        <mxPoint x="900" y="425" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="paygov-box" value="8. Validate cert&#xa;Generate token" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11" parent="1" vertex="1">
                    <mxGeometry x="840" y="445" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="step9" value="9. {token}" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;strokeColor=#b85450;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="900" y="515" as="sourcePoint"/>
                        <mxPoint x="420" y="515" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step11-box" value="10. Build response&lt;br&gt;paymentRedirect =&lt;br&gt;PAYMENT_URL?token=..." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11" parent="1" vertex="1">
                    <mxGeometry x="360" y="575" width="120" height="60" as="geometry"/>
                </mxCell>
                <mxCell id="step12" value="11. Log response" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=1;dashed=1;strokeColor=#9673a6;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="420" y="645" as="sourcePoint"/>
                        <mxPoint x="740" y="645" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="step13" value="12. Payment redirect link with token" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;strokeColor=#6c8ebf;" parent="1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="420" y="685" as="sourcePoint"/>
                        <mxPoint x="100" y="685" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="legend-box" value="Legend" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#000000;fontSize=12;fontStyle=1;verticalAlign=top" parent="1" vertex="1">
                    <mxGeometry x="-240" y="710" width="300" height="100" as="geometry"/>
                </mxCell>
                <mxCell id="legend-solid" value="─── Request" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=10" parent="1" vertex="1">
                    <mxGeometry x="-220" y="745" width="130" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="legend-dashed" value="- - - Response" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=10" parent="1" vertex="1">
                    <mxGeometry x="-220" y="765" width="130" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;strokeColor=#666666;" parent="1" edge="1">
                    <mxGeometry y="20" relative="1" as="geometry">
                        <mxPoint x="420" y="540" as="sourcePoint"/>
                        <mxPoint x="580" y="540" as="targetPoint"/>
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="3" value="Forward the user to the Pay.gov UI along with the token to fill out the payment information. They hit Pay, redirect back to the app to hit process-payment in Payment Portal" style="whiteSpace=wrap;html=1;aspect=fixed;" parent="1" vertex="1">
                    <mxGeometry x="45" y="510" width="140" height="140" as="geometry"/>
                </mxCell>
                <mxCell id="8" value="Note: Amount will only be required on copy fees. all other fees are optional. If amount is provided on non-copy fees, the request becomes invalid." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
                    <mxGeometry x="-70" y="140" width="130" height="110" as="geometry"/>
                </mxCell>
                <mxCell id="11" value="TODO: Talk about batch &#39;purchases&#39;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Update this with what we figured out in unique-id.drawio&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="-180" y="250" width="120" height="60" as="geometry"/>
                </mxCell>
                <mxCell id="14" value="&lt;b&gt;urlSuccess: &lt;/b&gt;user makes it all the way to the payment redirect url, user enters their payment info and it is VALID. The user is taken to the urlSuccess location defined in the initial request body. Note that we don&#39;t know if the payment was completed yet at this point, just that the payment info was valid to make the atttempt.&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;b&gt;urlCancel: &lt;/b&gt;User makes it all the way to the payment redirect url, but rather then entering their payment info they choose to cancel. The user is taken to the urlCancel location defined in the initial request body.&amp;nbsp;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;" parent="1" vertex="1">
                    <mxGeometry x="200" y="705" width="610" height="105" as="geometry"/>
                </mxCell>
                <UserObject label="{&#xa;  &quot;appId&quot;: &quot;DAWSON&quot;,&#xa;  &quot;transactionReferenceId&quot;: &quot;550e8400-e29b-41d4-a716-446655440000&quot;,&#xa;  &quot;urlSuccess&quot;: &quot;https://client.app/success&quot;,&#xa;  &quot;urlCancel&quot;: &quot;https://client.app/cancel&quot;,&#xa;  &quot;metadata&quot;: {&#xa;    &quot;docketNumber&quot;: &quot;123456&quot;,&#xa;    &quot;petitionNumber&quot;: &quot;PET-7890&quot;&#xa;  }&#xa;}" link="{&#xa;  &quot;appId&quot;: &quot;DAWSON&quot;,&#xa;  &quot;transactionUUID&quot;: &quot;550e8400-e29b-41d4-a716-446655440000&quot;,&#xa;  &quot;urlSuccess&quot;: &quot;https://client.app/success&quot;,&#xa;  &quot;urlCancel&quot;: &quot;https://client.app/cancel&quot;,&#xa;  &quot;metadata&quot;: {&#xa;    &quot;docketNumber&quot;: &quot;123456&quot;,&#xa;    &quot;petitionNumber&quot;: &quot;PET-7890&quot;&#xa;  }&#xa;}" id="15">
                    <mxCell style="text;whiteSpace=wrap;" vertex="1" parent="1">
                        <mxGeometry x="-10" y="-110" width="250" height="160" as="geometry"/>
                    </mxCell>
                </UserObject>
                <mxCell id="17" value="&lt;div style=&quot;background-color: rgb(31, 31, 31); font-family: Menlo, Monaco, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; line-height: 18px; white-space: pre;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;span&gt;&lt;font style=&quot;font-size: 8px; color: rgb(255, 255, 255);&quot;&gt;{&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 8px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(255, 255, 255), rgb(18, 18, 18));&quot;&gt;   &lt;font style=&quot;&quot;&gt; &lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(255, 255, 255);&quot;&gt;tcsAppId: request.appId,&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 8px;&quot;&gt;&lt;font style=&quot;color: rgb(255, 255, 255);&quot;&gt;    transactionAmount: request.amount,&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 8px; color: rgb(255, 255, 255);&quot;&gt;    urlCancel: request.urlCancel,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 8px; color: rgb(255, 255, 255);&quot;&gt;    urlSuccess: request.urlSuccess,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 8px; color: rgb(255, 255, 255);&quot;&gt;    agencyTrackingId: request.trackingId,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span&gt;&lt;font style=&quot;font-size: 8px; color: rgb(255, 255, 255);&quot;&gt;  }&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
                    <mxGeometry x="800" y="160" width="300" height="130" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>
